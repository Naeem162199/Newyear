<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor's New Year Greeting Generator</title>
    
    <!-- Preconnect to Google Fonts for faster connection -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Tailwind CSS (Script Version - parses rapidly) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Import Fonts with display=swap for instant text rendering */
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@700&display=swap');

        body { font-family: 'Lato', sans-serif; background-color: #f0f4f8; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }

        .design-card { transition: all 0.2s ease; border: 3px solid transparent; }
        .design-card:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .design-card.selected { border-color: #0ea5e9; transform: scale(1.02); box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2); }
        canvas { max-width: 100%; height: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Spinner Animation */
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4">

    <!-- Logo -->
    <div class="mb-6">
        <!-- Replace src with your actual logo path -->
        <img src="logo.png" alt="Clinic Logo" class="h-32 object-contain">
    </div>

    <!-- Header -->
    <div class="text-center mb-8 max-w-2xl">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">New Year Greetings 2025</h1>
        <p class="text-slate-500">Select a template, personalize it, and share.</p>
    </div>

    <!-- Main Content -->
    <div class="w-full max-w-6xl flex flex-col lg:grid lg:grid-cols-12 gap-6 lg:gap-8">
        
        <!-- Controls -->
        <div class="lg:col-span-4 lg:col-start-1 lg:row-start-1 space-y-6">
            <!-- 1. Design -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-sky-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span>
                    Select Design
                </h2>
                <div class="grid grid-cols-2 gap-3" id="designGrid"></div>
            </div>

            <!-- 2. Details -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-sky-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>
                    Your Details
                </h2>
                
                <!-- Custom Message Input (Moved to Top) -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-slate-700">Custom Message</label>
                        <span id="msgCount" class="text-xs text-slate-400 font-mono">0/60</span>
                    </div>
                    <input type="text" id="messageInput" maxlength="60"
                        class="block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-3 border" 
                        placeholder="e.g. Wishing you good health"
                        value="Wish you a happy new year!"
                        oninput="updateCanvas()">
                    <p class="text-xs text-slate-400 mt-1">Appears above your name.</p>
                </div>

                <!-- Name Input (Moved Below) -->
                <div class="mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <label class="block text-sm font-medium text-slate-700">Doctor's Name</label>
                        <span id="nameCount" class="text-xs text-slate-400 font-mono">0/25</span>
                    </div>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <span class="text-slate-400">Dr.</span>
                        </div>
                        <input type="text" id="nameInput" maxlength="25"
                            class="pl-10 block w-full rounded-md border-slate-300 shadow-sm focus:border-sky-500 focus:ring-sky-500 sm:text-sm p-3 border" 
                            placeholder="John Doe"
                            oninput="updateCanvas()">
                    </div>
                    <p class="text-xs text-slate-400 mt-1">Appears in the center.</p>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="lg:col-span-8 lg:col-start-5 lg:row-start-1 lg:row-span-2">
            <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-100 flex justify-center items-center bg-slate-50 sticky top-4">
                <canvas id="previewCanvas" width="800" height="600" class="bg-white"></canvas>
            </div>
            <div class="text-center mt-4">
                <span class="text-xs text-slate-400 uppercase tracking-widest font-semibold">Live Preview</span>
            </div>
        </div>

        <!-- Download -->
        <div class="lg:col-span-4 lg:col-start-1 lg:row-start-2 h-fit">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                    <span class="bg-sky-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">3</span>
                    Download
                </h2>
                <button onclick="downloadCard()" id="downloadBtn" class="w-full flex justify-center items-center space-x-2 bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    <!-- SVG Icon -->
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    <span id="btnText">Download Image</span>
                </button>
                <p id="statusMsg" class="text-center text-xs text-slate-500 mt-3 hidden"></p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxdO0_ht-jEuPCjv7-2BPIoducquOyoV0L7kHvNZfBcQ4_8bX8VdLTE9F2arIkzT_zC/exec"; 

        // DESIGNS
        // NOTE: In the live environment below, we use 'placehold.co' URLs so the preview works immediately.
        // WHEN DEPLOYING TO GITHUB: Replace the 'bgUrl' values with "1.png", "2.png", "3.png", "4.png"
        // and ensure those image files are in the same folder as this index.html file.
        const designs = [
            { id: 1, name: "Option 1", color: "#2563EB", textColor: "#172554", bgUrl: "2.png", textX: 400, textY: 330, textAlign: "center" },
            { id: 2, name: "Option 2", color: "#9d4014", textColor: "#9d4014", bgUrl: "1.png", textX: 400, textY: 330, textAlign: "center" },
            { id: 3, name: "Option 3", color: "#4B5563", textColor: "#fafafa", bgUrl: "3.png", textX: 400, textY: 330, textAlign: "center" },
            { id: 4, name: "Option 4", color: "#DC2626", textColor: "#fafafa", bgUrl: "4.png", textX: 400, textY: 330, textAlign: "center" }
        ];

        // ==========================================
        // APP LOGIC
        // ==========================================
        
        let selectedDesign = designs[0];
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        const nameInput = document.getElementById('nameInput');
        const messageInput = document.getElementById('messageInput');
        
        // Counters
        const nameCount = document.getElementById('nameCount');
        const msgCount = document.getElementById('msgCount');

        const imageCache = {};

        // Start immediately
        init();

        function init() {
            renderDesignGrid();
            drawLoadingState(); 
            preloadImages();    
        }

        function renderDesignGrid() {
            const grid = document.getElementById('designGrid');
            grid.innerHTML = '';
            designs.forEach(design => {
                const div = document.createElement('div');
                div.className = `design-card cursor-pointer rounded-lg overflow-hidden relative ${design.id === selectedDesign.id ? 'selected' : ''}`;
                div.onclick = () => selectDesign(design);
                // Background opacity reduced slightly for better button visual
                div.innerHTML = `<div style="background-color: ${design.color}15; height: 80px;" class="flex items-center justify-center"><span style="color: ${design.color}" class="font-bold text-xs">${design.name}</span></div>`;
                grid.appendChild(div);
            });
        }

        function drawLoadingState() {
            ctx.fillStyle = "#f8fafc";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.font = "20px Lato, system-ui";
            ctx.fillStyle = "#94a3b8";
            ctx.textAlign = "center";
            ctx.fillText("Loading Preview...", canvas.width/2, canvas.height/2);
        }

        function preloadImages() {
            designs.forEach(design => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = design.bgUrl;
                img.onload = () => {
                    imageCache[design.bgUrl] = img;
                    if(selectedDesign.id === design.id) updateCanvas();
                };
                img.onerror = () => console.error("Failed to load: " + design.bgUrl);
            });
        }

        function selectDesign(design) {
            selectedDesign = design;
            renderDesignGrid();
            updateCanvas();
        }

        function updateCanvas() {
            // Update Character Counts
            nameCount.innerText = `${nameInput.value.length}/25`;
            msgCount.innerText = `${messageInput.value.length}/60`;

            if (imageCache[selectedDesign.bgUrl]) {
                drawToCanvas(imageCache[selectedDesign.bgUrl]);
            } else {
                drawLoadingState();
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = selectedDesign.bgUrl;
                img.onload = () => {
                    imageCache[selectedDesign.bgUrl] = img;
                    drawToCanvas(img);
                };
            }
        }

        // --- Helper function to calculate line breaks ---
        function getLines(ctx, text, maxWidth) {
            const words = text.split(" ");
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
            return lines;
        }

        function drawToCanvas(img) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

            const name = nameInput.value ? "Dr. " + nameInput.value : "Dr. Name Here";
            const message = messageInput.value;
            
            ctx.fillStyle = selectedDesign.textColor;
            const align = selectedDesign.textAlign || "center"; 
            ctx.textAlign = align;

            // --- 1. Draw Custom Message (Center, Above Name) ---
            if (message) {
                // Font Size: 16px (Small)
                ctx.font = `italic bold 16px 'Playfair Display', serif, system-ui`;
                // Position above the name.
                ctx.fillText(message, selectedDesign.textX, selectedDesign.textY - 25);
            }

            // --- 2. Draw Doctor Name (Center, below message) ---
            // Font Size: 18px (Small)
            let fontSize = 18; 
            ctx.font = `bold ${fontSize}px 'Playfair Display', serif, system-ui`;
            
            // Define Safety Width (60% of card width since it's centered)
            const maxTextWidth = canvas.width * 0.6; 
            
            // Shrink text slightly if it's huge, stop at 12px
            while (ctx.measureText(name).width > maxTextWidth && fontSize > 12) {
                fontSize -= 2;
                ctx.font = `bold ${fontSize}px 'Playfair Display', serif, system-ui`;
            }

            // Calculate Wrapping for Name
            let lines = [name];
            if (ctx.measureText(name).width > maxTextWidth) {
                lines = getLines(ctx, name, maxTextWidth);
            }

            // Draw Name (Bottom-Up from anchor point)
            const lineHeight = fontSize * 1.2;
            let currentY = selectedDesign.textY; // Anchor point
            
            for (let i = lines.length - 1; i >= 0; i--) {
                ctx.fillText(lines[i], selectedDesign.textX, currentY);
                currentY -= lineHeight; // Move up for previous line
            }

            // Draw Underline (Under last line of name)
            const lastLine = lines[lines.length - 1];
            const textWidth = ctx.measureText(lastLine).width;
            let lineX;
            
            if (align === "right") lineX = selectedDesign.textX - textWidth;
            else if (align === "left") lineX = selectedDesign.textX;
            else lineX = selectedDesign.textX - (textWidth / 2); // Center alignment
            
            // Adjusted underline position
            ctx.fillRect(lineX, selectedDesign.textY + 10, textWidth, 2);
        }

        async function downloadCard() {
            const btn = document.getElementById('downloadBtn');
            const btnText = document.getElementById('btnText');
            const status = document.getElementById('statusMsg');
            const name = nameInput.value;
            const message = messageInput.value;

            if(!name) { alert("Please enter your name first!"); nameInput.focus(); return; }

            btn.disabled = true;
            const originalText = btnText.innerText;
            btnText.innerHTML = "Processing...";
            status.classList.remove('hidden');
            status.innerText = "Saving record...";

            if (GOOGLE_SCRIPT_URL) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: "Dr. " + name,
                            message: message, 
                            design: selectedDesign.name,
                            timestamp: new Date().toISOString()
                        })
                    });
                } catch (e) { console.error(e); }
            }

            setTimeout(() => {
                const link = document.createElement('a');
                const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `greeting_card_${safeName}.png`;
                link.href = canvas.toDataURL();
                link.click();

                btn.disabled = false;
                btnText.innerText = originalText;
                status.innerText = "Download started!";
                setTimeout(() => { status.classList.add('hidden'); }, 3000);
            }, 500);
        }
    </script>
</body>
</html>








